### Variables
@baseUrl = http://localhost:3000
@contentType = application/json
@userId = 67c9dcd230beec3d0e0c19c6
@jwtToken = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI2N2M5ZGNkMjMwYmVlYzNkMGUwYzE5YzYiLCJpYXQiOjE3NDE1MTk4MzEsImV4cCI6MTc0MTYwNjIzMX0.SfO02oZ0rGymAZZCboUbWHvBX4QY3LfjbOmtaVyXjD0

### Test root endpoint
# @name root
GET {{baseUrl}}/
Content-Type: {{contentType}}

### Create a new user
# @name createUser
POST {{baseUrl}}/users
Content-Type: {{contentType}}

{
    "name": "Tom√©",
    "email": "tome.m.dj@gmail.com"
}

### Get user by ID (replace ID with the _id from the createUser response)
# @name getUser
GET {{baseUrl}}/users/{{userId}}
Content-Type: {{contentType}}

### Test invalid user ID (should return 404)
# @name getUserNotFound
GET {{baseUrl}}/users/123456789012345678901234
Content-Type: {{contentType}}

### Create volunteered data
# @name createVolunteeredData
POST {{baseUrl}}/volunteered-data
Content-Type: {{contentType}}

{
    "userId": "{{userId}}",
    "type": "personal_info",
    "value": {
        "age": 30,
        "occupation": "Software Engineer"
    }
}

### Create behavioral data
# @name createBehavioralData
POST {{baseUrl}}/behavioral-data
Content-Type: {{contentType}}

{
    "userId": "{{userId}}",
    "action": "page_view",
    "context": {
        "page": "/dashboard",
        "timestamp": "2024-03-01T12:00:00Z",
        "device": "desktop"
    }
}

### Create external data
# @name createExternalData
POST {{baseUrl}}/external-data
Content-Type: {{contentType}}

{
    "userId": "{{userId}}",
    "source": "github",
    "data": {
        "repos": 25,
        "followers": 150,
        "languages": ["TypeScript", "Python", "Go"]
    }
}

### Get all user data (includes volunteered, behavioral, and external data)
# @name getUserData
GET {{baseUrl}}/user-data/{{userId}}
Content-Type: {{contentType}}

### Test validation errors

### Test missing fields in volunteered data (should return 400)
# @name createVolunteeredDataError
POST {{baseUrl}}/volunteered-data
Content-Type: {{contentType}}

{
    "userId": "{{userId}}"
}

### Test missing fields in behavioral data (should return 400)
# @name createBehavioralDataError
POST {{baseUrl}}/behavioral-data
Content-Type: {{contentType}}

{
    "userId": "{{userId}}",
    "action": "page_view"
}

### Test missing fields in external data (should return 400)
# @name createExternalDataError
POST {{baseUrl}}/external-data
Content-Type: {{contentType}}

{
    "userId": "{{userId}}",
    "source": "github"
}

### Update user by ID
# @name updateUser
PUT {{baseUrl}}/users/{{userId}}
Content-Type: {{contentType}}

{
    "name": "Updated User",
    "email": "updated@example.com"
}

### User Data Sources Tests ###

### Store Gmail credentials
# @name storeGmailCredentials
POST {{baseUrl}}/user-data-sources
Content-Type: {{contentType}}

{
    "userId": "{{userId}}",
    "dataSourceType": "gmail",
    "credentials": {
        "accessToken": "ya29.a0AfB_byC...",
        "refreshToken": "1//04u...",
        "expiry": "2024-03-21T12:00:00.000Z"
    }
}

### Store Plaid credentials
# @name storePlaidCredentials
POST {{baseUrl}}/user-data-sources
Content-Type: {{contentType}}

{
    "userId": "{{userId}}",
    "dataSourceType": "plaid",
    "credentials": {
        "accessToken": "access-sandbox-e0d1c838-d760-46ce-808d-08d75ea61bdd",
        "itemId": "KzAJNdml86IraWMqR61BuWAqkVeA9kiVvG9AL",
        "expiry": "2024-03-21T12:00:00.000Z"
    }
}

### Get Gmail credentials
# @name getGmailCredentials
GET {{baseUrl}}/user-data-sources/{{userId}}/gmail

### Get Plaid credentials
# @name getPlaidCredentials
GET {{baseUrl}}/user-data-sources/{{userId}}/plaid

### Test validation errors for user data sources

### Try invalid data source type (should return 400)
# @name invalidDataSourceType
POST {{baseUrl}}/user-data-sources
Content-Type: {{contentType}}

{
    "userId": "{{userId}}",
    "dataSourceType": "invalid",
    "credentials": {
        "accessToken": "test"
    }
}

### Try missing credentials (should return 400)
# @name missingCredentials
POST {{baseUrl}}/user-data-sources
Content-Type: {{contentType}}

{
    "userId": "{{userId}}",
    "dataSourceType": "gmail"
}

### Test Gmail token generation
# @name testGmailToken
POST {{baseUrl}}/test/test-gmail-token
Content-Type: {{contentType}}

{
    "userId": "{{userId}}"
}

### Get Gmail authorization URL
# @name getGmailAuthUrl
GET {{baseUrl}}/test/gmail-auth-url?userId={{userId}}
Content-Type: {{contentType}}

### Get Plaid authorization URL (returns redirect URL)
# @name getPlaidAuthUrl
GET {{baseUrl}}/test/plaid-auth-url?userId={{userId}}
Content-Type: {{contentType}}

### Test Gmail data fetching
# @name gmailFetch
POST {{baseUrl}}/test/test-gmail-fetch
Content-Type: {{contentType}}

{
    "userId": "{{userId}}"
}

### Test Plaid Token Generation
# @name testPlaidToken
POST {{baseUrl}}/test/test-plaid-token
Content-Type: application/json

{
    "userId": "{{userId}}"
}

### Test Plaid data fetching
# @name plaidFetch
POST {{baseUrl}}/test/test-plaid-fetch
Content-Type: {{contentType}}

{
    "userId": "{{userId}}"
}

### Manually trigger data ingestion
# @name runDataIngestion
POST {{baseUrl}}/test/run-data-ingestion
Content-Type: {{contentType}}

### JWT Authentication Tests ###
# To use these tests:
# 1. First run the "login" request to get a JWT token
# 2. Copy the token from the response and replace the @jwtToken variable at the top of this file
# 3. Then run the other JWT-authenticated requests

### Login to get JWT token
# @name login
POST {{baseUrl}}/auth/login
Content-Type: {{contentType}}

{
    "userId": "{{userId}}"
}

### Access protected route with JWT
# @name protectedRoute
GET {{baseUrl}}/auth/protected
Content-Type: {{contentType}}
Authorization: Bearer {{jwtToken}}

### Access Gmail auth with JWT (will redirect to Google)
# @name gmailAuthWithJWT
GET {{baseUrl}}/auth/gmail
Content-Type: {{contentType}}
Authorization: Bearer {{jwtToken}}

### Test protected route without token (should return 401)
# @name protectedRouteUnauthorized
GET {{baseUrl}}/auth/protected
Content-Type: {{contentType}}

### Test Gmail auth URL with JWT
# @name gmailAuthUrlWithJWT
GET {{baseUrl}}/test/gmail-auth-url
Content-Type: {{contentType}}
Authorization: Bearer {{jwtToken}}

### Test Plaid auth URL with JWT
# @name plaidAuthUrlWithJWT
GET {{baseUrl}}/test/plaid-auth-url
Content-Type: {{contentType}}
Authorization: Bearer {{jwtToken}}

### Test Gmail token with JWT
# @name testGmailTokenWithJWT
POST {{baseUrl}}/test/test-gmail-token
Content-Type: {{contentType}}
Authorization: Bearer {{jwtToken}}

### Test Plaid token with JWT
# @name testPlaidTokenWithJWT
POST {{baseUrl}}/test/test-plaid-token
Content-Type: {{contentType}}
Authorization: Bearer {{jwtToken}}

### Test Gmail data fetching with JWT
# @name gmailFetchWithJWT
POST {{baseUrl}}/test/test-gmail-fetch
Content-Type: {{contentType}}
Authorization: Bearer {{jwtToken}}

### Test Plaid data fetching with JWT
# @name plaidFetchWithJWT
POST {{baseUrl}}/test/test-plaid-fetch
Content-Type: {{contentType}}
Authorization: Bearer {{jwtToken}}

### Manually trigger data ingestion with JWT
# @name runDataIngestionWithJWT
POST {{baseUrl}}/test/run-data-ingestion
Content-Type: {{contentType}}
Authorization: Bearer {{jwtToken}}

### JWT Authentication Tests with Validation ###

### Login with empty userId (should return 400)
# @name loginValidationError
POST {{baseUrl}}/auth/login
Content-Type: {{contentType}}

{
    "userId": ""
}

### Login with missing userId (should return 400)
# @name loginValidationErrorMissing
POST {{baseUrl}}/auth/login
Content-Type: {{contentType}}

{
}

### Test API validation with empty userId (should return 400)
# @name apiValidationError
GET {{baseUrl}}/api/plaid/create-link-token?userId=
Content-Type: {{contentType}}

### Test API validation with missing userId (should return 400)
# @name apiValidationErrorMissing
GET {{baseUrl}}/api/plaid/create-link-token
Content-Type: {{contentType}}

### Test API validation with missing fields (should return 400)
# @name apiValidationErrorMissingFields
POST {{baseUrl}}/api/plaid/exchange-public-token
Content-Type: {{contentType}}

{
    "userId": "{{userId}}"
}

### Test API validation with empty fields (should return 400)
# @name apiValidationErrorEmptyFields
POST {{baseUrl}}/api/plaid/exchange-public-token
Content-Type: {{contentType}}

{
    "userId": "{{userId}}",
    "public_token": ""
}

###